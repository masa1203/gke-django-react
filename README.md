# GKE に Django+React をデプロイする

## やりたいこと

Docker で環境構築して k8s にデプロイしたい。
バックエンドは DjangoRestFramework で RestAPI を配信して、フロントエンドは React(TypeScript)で実装したい。

## 環境

```sh
node --version
v12.14.1

npm --version
6.13.7

python --version
Python 3.7.4

docker --version
Docker version 19.03.8
```

1. アプリケーションを作成する
   ローカルで起動できることを確認する

2. GCP でプロジェクトを作成する
   CloudSQL, CloudStorage を使ってローカルからクラウドのマネージドサービスを利用できるようにする。

3. Docker イメージを作成する
   イメージを作成する。.env は省いた方が良いがこれはまだ対応していない。

4. GKE のクラスタを作成する
   プロジェクトを開始して GKE クラスタを作成する。

5. Deployment を作成する
   backend の Secret を作成してデータベースに利用。

6. Service を作成する
   backend と frontend

7. Ingress を作成する

8. ヘルスチェックに対応する
   ヘルスチェックに対応する。
   静的アドレスに追加する。200 を返すように view を追加。

9. DNS に対応する
   ドメインを取得して ingress に host を追加。

10. HTTPS 化
    https://qiita.com/watiko/items/71d78a4d31eee02cb47d

## まずはローカルで始める

### ディレクトリを作成する。

```sh
# プロジェクトフォルダの作成
$ mkdir gke-django-tutorial
$ cd gke-django-tutorial
# ディレクトリを作成する
$\gke-django-tutorial\mkdir backend
$\gke-django-tutorial\mkdir frontend
```

### Backend の開発を始める

backend は Djang-rest-framework で RestAPI を作成します。
まずは backend から環境を作成してみます。

```sh
# backendディレクトリに移動
$\gke-django-tutorial\cd backend
# Pythonの仮想環境作成
$\gke-django-tutorial\backend\python -m venv venv
# 仮想環境の有効化
$\gke-django-tutorial\backend\vnev\Scripts\activate
# Pythonパッケージのインストール
(venv)$\gke-django-tutorial\backend\python -m install --upgrade pip setuptools
(venv)$\gke-django-tutorial\backend\python -m install django djangorestframework python-dotenv
# Djangoのプロジェクトを始める
(venv)$\gke-django-tutorial\backend\django-admin startproject config .
```

backend ディレクトリ下で`django-admin startprject config .`とすることで
`config`という Django プロジェクトフォルダが作成されました。

ローカルサーバーが起動するかどうか確認しましょう。

```sh
(venv)$\gke-django-tutorial\backend\python manage.py runserver
Watching for file changes with StatReloader
Performing system checks...

System check identified no issues (0 silenced).

You have 17 unapplied migration(s). Your project may not work properly until you apply the migrations for app(s): admin, auth, contenttypes, sessions.
Run 'python manage.py migrate' to apply them.
April 27, 2020 - 11:22:06
Django version 3.0.5, using settings 'config.settings'
Starting development server at http://127.0.0.1:8000/
Quit the server with CTRL-BREAK.
```

開発用サーバーが起動したので`http://localhost:8000/`にアクセスすると`The install worked successfully!`の画面が確認できます。

#### settings.py

`config/settings.py`を編集して基本的な設定を盛り込みます。
settings.py の秘匿すべき情報は`.env`ファイルに記述して公開しないようにします。
python-dotenv を使って`.env`に記載された情報を利用するように変更しましょう。

```sh
# .envファイルの作成
(venv)$\gke-django-tutorial\backend\type null > .env
```

```python:config.settins.py
# config/settings.py

"""
Django settings for config project.

Generated by 'django-admin startproject' using Django 3.0.5.

For more information on this file, see
https://docs.djangoproject.com/en/3.0/topics/settings/

For the full list of settings and their values, see
https://docs.djangoproject.com/en/3.0/ref/settings/
"""

import os
from dotenv import load_dotenv  # 追加

# Build paths inside the project like this: os.path.join(BASE_DIR, ...)
BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
PROJECT_DIR = os.path.basename(BASE_DIR)  # 追加

# .envの読み込み
load_dotenv(os.path.join(BASE_DIR, '.env'))  # 追加

# Quick-start development settings - unsuitable for production
# See https://docs.djangoproject.com/en/3.0/howto/deployment/checklist/

# SECURITY WARNING: keep the secret key used in production secret!
SECRET_KEY = os.getenv('SECRET_KEY')

# SECURITY WARNING: don't run with debug turned on in production!
DEBUG = os.getenv('DEBUG')

ALLOWED_HOSTS = ["*"]  # 変更


# Application definition

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
]

MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]

ROOT_URLCONF = 'config.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [os.path.join(BASE_DIR, 'templates')],  # 変更
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

WSGI_APPLICATION = 'config.wsgi.application'


# Database
# https://docs.djangoproject.com/en/3.0/ref/settings/#databases

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': os.path.join(BASE_DIR, 'db.sqlite3'),
    }
}


# Password validation
# https://docs.djangoproject.com/en/3.0/ref/settings/#auth-password-validators

AUTH_PASSWORD_VALIDATORS = [
    {
        'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
    },
]


# Internationalization
# https://docs.djangoproject.com/en/3.0/topics/i18n/

LANGUAGE_CODE = 'ja'  # 変更

TIME_ZONE = 'Asia/Tokyo'

USE_I18N = True

USE_L10N = True

USE_TZ = True


# Static files (CSS, JavaScript, Images)
# https://docs.djangoproject.com/en/3.0/howto/static-files/

STATIC_URL = '/static/'


# 開発環境下で静的ファイルを参照する先
STATICFILES_DIRS = [os.path.join(BASE_DIR, 'static')] # 追加

# 本番環境で静的ファイルを参照する先
STATIC_ROOT = os.path.join(BASE_DIR, 'staticfiles') # 追加

# メディアファイルpath
MEDIA_URL = '/media/' # 追加

```

```sh:.env
# .env
SECRET_KEY = 'nz8t((i_mali=%0+z_g+uc**9dgky8)74slvs&6h$=9b^8t7$@'
DEBUG = False
```

#### アプリケーションを追加する

todo アプリケーションを作っていきましょう。

```sh
(venv)$\gke-django-tutorial\backend\python manage.py startapp todo
```

`config/settings.py` の`INSTALLED_APPS`に`todo`と`rest_framework`を追加します。

```python
# config/settings.py

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',

    # 3rd party
    'rest_framework',

    # Local
    'todo.apps.TodoConfig',
]

# 追加
REST_FRAMEWORK = {
    'DEFAULT_PERMISSION_CLASSES': [
        'rest_framework.permissions.AllowAny',
    ]
}

```
`rest_framework.permissions.AllowAny`は django-rest-framework が暗黙的に決めているデフォルトの設定`'DEFAULT_PERMISSION_CLASSES'`を解除するためのものです。
この設定はまだよくわかってないのですがとりあえず前に進みます。

#### todo/models.py

`todo`アプリケーション model を作成します。

```python
# todo/models.py
from django.db import models


class Todo(models.Model):
    title = models.CharField(max_length=200)
    body = models.TextField()

    def __str__(self):
        return self.title

```

`todo/admin.py`に作成したモデルを追加します。

```python
# todo/admin.py
from django.contrib import admin
from .models import Todo


admin.site.register(Todo)
```

マイグレーションします。

```sh
(venv)$\gke-django-tutorial\backend\python manage.py makemigrations
Migrations for 'todo':
  todo\migrations\0001_initial.py
    - Create model Todo

(venv)$\gke-django-tutorial\backend\python manage.py migrate
Operations to perform:
  Apply all migrations: admin, auth, contenttypes, sessions, todo
Running migrations:
  Applying contenttypes.0001_initial... OK
  Applying auth.0001_initial... OK
  Applying admin.0001_initial... OK
  Applying admin.0002_logentry_remove_auto_add... OK
  Applying admin.0003_logentry_add_action_flag_choices... OK
  Applying contenttypes.0002_remove_content_type_name... OK
  Applying auth.0002_alter_permission_name_max_length... OK
  Applying auth.0003_alter_user_email_max_length... OK
  Applying auth.0004_alter_user_username_opts... OK
  Applying auth.0005_alter_user_last_login_null... OK
  Applying auth.0006_require_contenttypes_0002... OK
  Applying auth.0007_alter_validators_add_error_messages... OK
  Applying auth.0008_alter_user_username_max_length... OK
  Applying auth.0009_alter_user_last_name_max_length... OK
  Applying auth.0010_alter_group_name_max_length... OK
  Applying auth.0011_update_proxy_permissions... OK
  Applying sessions.0001_initial... OK
  Applying todo.0001_initial... OK
```

#### createsuperuser

管理者ユーザーを作成します。

```sh
(venv)$\gke-django-tutorial\backend\python manage.py createsuperuser
ユーザー名 (leave blank to use 'you'): admin
メールアドレス: XXXXX@gmail.com
Password:
Password (again):
Superuser created successfully.
```

開発用サーバーを起動して`http://localhost:8000/admin`にアクセスすると
Django管理サイトが表示されます。
先ほど設定したユーザー名、パスワードを入力してログインしてみましょう。

作成したアプリケーション`Todo`のテーブルを確認することができます。
2，3コアイテムを追加しておきましょう。

#### URLs

`config/urls.py`に todo へのルーティングを追加します。

```python
# config/urls.py

from django.contrib import admin
from django.urls import path, include

urlpatterns = [
    path('admin/', admin.site.urls),
    path('api/', include('todo.urls'))  # 追加
]

```

#### todo/urls.py

`todos/urls.py`を作成します。

```sh
(venv)$\gke-django-tutorial\backend\type null > todo\urls.py
```

```python
# todo/urls.py
from django.urls import path, include
from .views import ListTodo, DetailTodo

urlpatterns = [
    path('<int:pk>', DetailTodo.as_view()),
    path('', ListTodo.as_view())
]
```

#### todo/selializers.py

モデルインスタンスを簡単にjson形式に変換するためのシリアライザーを作成します。

```sh
(venv)$\gke-django-tutorial\backend\type null > todo\serializers.py
```

```python
# todo/serializers.py
from rest_framework import serializers
from .models import Todo


class TodoSerializer(serizers.ModelSerializer):
    class Meta:
        model = Todo
        fields = ('id', 'title', 'body')

```

`fields = ('id', 'title', 'text')`での`id`は PrimaryKey を指定しない場合、
Django によって自動的に追加されます。

#### todo/views.py

Django Rest Frameworkで`views.py`を作成する場合は`rest_framework.generics`のAPIViewを継承します。

```python
# todo/views.py

from django.shortcuts import render
from rest_framework import generics
from .models import Todo
from .serializers import TodoSerializer


class ListTodo(generics.ListAPIView):
    queryset = Todo.objects.all()
    serializer_class = TodoSerializer


class DetailTodo(generics.RetrieveAPIView):
    queryset = Todo.objects.all()
    serializer_class = TodoSerializer
```

router など設定できていませんが、とりあえずは Todo アイテムを API として使用できるようになりました。
開発サーバーで`http://127.0.0.1:8000/api/`にアクセスすると APIview を確認することができます。

ここまでは Django でよくあるローカル環境での開発です。

#### CORS

CORS(Cross-Origin Resource Sharing)は React と Django を連携させる場合、
React を起動した`localhost:3000`は Django の API サーバー`localhost:8000`と
json のやり取りを行わせるためのものです。
`django-cors-headers`をインストールしましょう。

```sh
(venv)$\gke-django-tutorial\backend\python -m pip install django-cors-headers
```

`config/settings.py`を更新します。

```python
# config/settings.py

# Application definition

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',

    # 3rd party
    'rest_framework',
    'corsheaders',

    # Local
    'todos.apps.TodosConfig',
]

MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'corsheaders.middleware.CorsMidddleware',  # 追加
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]

##################
# rest_framework #
##################

REST_FRAMEWORK = {
    'DEFAULT_PERMISSION_CLASSES': [
        'rest_framework.permissions.AllowAny',
    ]
}

CORS_ORIGIN_WHITELIST = (
    'http://localhost:3000',
)
```

#### local_settings.py

`config/settings.py`は本番環境に使用することを考慮し、`config/local_settings.py`を作成してローカル開発用に分けておきます。
GKEデプロイ時にはCloudSQLを使用し、ローカルではsqlite3を使用するように、settings.pyを分けておくことで設定値を書き換えずに済みます。

```sh
# ファイルの作成
(venv)$\gke-django-tutorial\backend\type null > config/local_settings.py
```

```python
# config/local_settings.py
from .settings import *

DEBUG = True

ALLOWED_HOSTS = ['*']

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': os.path.join(BASE_DIR, 'db.sqlite3'),
    }
}
```

`config/local_settings.py`を使って開発用サーバーを起動しておきます。

```sh
(venv)$\gke-django-tutorial\backend\python manage.py runserver --settings config.local_settings
```

#### Tests

テストを書きます。

```python
# todos/test.py

from django.test import TestCase
from .models import Todo


class TodoModelTest(TestCase):

    @classmethod
    def setUpTestData(cls):
        Todo.objects.create(title="first todo", body="a body here")

    def test_title_content(self):
        todo = Todo.objects.get(id=1)
        excepted_object_name = f'{todo.title}'
        self.assertEqual(excepted_object_name, 'first todo')

    def test_body_content(self):
        todo = Todo.objects.get(id=1)
        excepted_object_name = f'{todo.body}'
        self.assertEqual(excepted_object_name, 'a body here')

```

```sh
(venv)$\gke-django-tutorial\backend\ python manage.py test
Creating test database for alias 'default'...
System check identified no issues (0 silenced).
..
----------------------------------------------------------------------
Ran 2 tests in 0.007s

OK
Destroying test database for alias 'default'...
```

うまくいったようです。

#### 静的ファイル

配信後に管理者機能のcssが反映されるように静的ファイルを集約しておきます。

```sh
# 静的ファイル用ディレクトリ
(venv)$\gke-django-tutorial\backend\mkdir static
# 静的ファイルの集約
(venv)$\gke-django-tutorial\backend\python manage.py collectstatic
```

#### requirements.txt

仮想環境にインストールしたPythonパッケージをrequirements.txtにまとめておきます。

```sh
# 静的ファイル用ディレクトリ
(venv)$\gke-django-tutorial\backend\python -m pip freeze > requirements.txt
```

実行するとbackend/下にrequirements.txtが作成されます。

```txt
asgiref==3.2.7
Django==3.0.5
django-cors-headers==3.2.1
djangorestframework==3.11.0
python-dotenv==0.13.0
pytz==2019.3
sqlparse==0.3.1
```

### Frontendの開発を進める

新しいコマンドプロンプトを開いてReactのプロジェクトを開始していきます。

```sh
# ディレクトリ下にReactプロジェクトをたてる
$\gke-django-tutorial\frontend\npx create-react-app .
# Reactの開発用サーバーを立ち上げる
$\gke-django-tutorial\frontend\yarn start
yarn run v1.22.0
$ react-scripts start
i ｢wds｣: Project is running at http://192.168.11.8/
i ｢wds｣: webpack output is served from
i ｢wds｣: Content not from webpack is served from C:\Users\masayoshi\docker_project\gke-django-tutorial_v2\frontend\public
i ｢wds｣: 404s will fallback to /
Starting the development server...
Compiled successfully!

You can now view frontend in the browser.

  Local:            http://localhost:3000
  On Your Network:  http://192.168.11.8:3000

Note that the development build is not optimized.
To create a production build, use yarn build.
```

`http://localhost:3000`にアクセスするとReactのWelcomeページが確認できます。

APIをリクエストするのには`axios`を使います。

```sh
# ライブラリのインストール
$\gke-django-tutorial\frontend\yarn add axios
```

#### App.js
APIのエンドポイントは以下のような形でAPIを返してきます。

```javascript
// src/App.js
import React from 'react';
import axios from "axios";
import './App.css';

class App extends Component {
  state = {
    todo: []
  };

  componentDidMount() {
    this.getTodos();
  }

  getTodos() {
    axios
      .get("http://localhost:8000/api/")
      .then(res => {
        this.setState({ todo: res.data });
      })
      .catch(err => {
        console.log(err);
      });
  }
  render() {
    return (
      <div>
        {this.state.todo.map(item => (
          <div key={item.id}>
            <h1>{item.title}</h1>
            <p>{item.body}</p>
          </div>
        ))}
      </div>
    );
  }
}

export default App;

```

これローカル環境でfronendからbarckendへのapiを叩いてtodoリスト一覧を表示させることができました。

## Docker化

次はこれをDocker化していきます。
frontend, backendそれぞれにDockerfileを作成してbackendコンテナ、frontendコンテナを作成します。
開発環境はdocker-composeで構築するように進めていきます。

docker-composeで立ち上げられるところまでを考えていきます。

### backendのDocker化

#### settings.py

backendをdockerコンテナ化する際に環境変数は`.env`で指定することができます。
これまでは`python-dotenv`で`.env`ファイルを参照していましたが、環境変数を参照するように
変更しましょう。

まずは`config/local_settings.py`を変更します。

```python
# config/local_settings.py
from .settings import *

SECRET_KEY = os.environ.get('SECRET_KEY')  # 追加

DEBUG = True

ALLOWED_HOSTS = ['*']

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': os.path.join(BASE_DIR, 'db.sqlite3'),
    }
}
```

```python
# config/settings.py
import os

# SECURITY WARNING: keep the secret key used in production secret!
SECRET_KEY = os.environ.get('SECRET_KEY')  # 変更

# SECURITY WARNING: don't run with debug turned on in production!
DEBUG = os.environ.get('DEBUG')  # 変更

```

GKEデプロイ時にはCloudSQLを使用します。その時にDATABASE部分は変更します。

#### Dockerfile

Dockerfileを作っていきます。

```sh
# Dockerfileの作成
$\gke-django-tutorial\backend\type null > Dockerfile
```

```Dockerfile
# backend/Dockerfile

# set base image
FROM python:3.7

# set environment variables
ENV PYTHONDONTWRITEBYTECODE 1
ENV PYTHONUNBUFFERED 1

# set work directory
RUN mkdir /code
WORKDIR /code

# install dependencies
COPY requirements.txt /code/
RUN python3 -m pip install --upgrade pip setuptools
RUN pip install -r requirements.txt

# Copy project
COPY . /code/

EXPOSE 8000

```

#### .dockerignore

このままだと秘匿するべき`.env`ファイルも一緒にコピーされてしまいます。
`.dockerignore`を追加して`.env`が追加されないようにします。

```sh
$\gke-django-tutorial\backend\type nul > .dockerignore
```

```dockerfile
# .dockerignore
.env
```

#### docker-compose.yml

次にプロジェクトディレクトリにdocker-compose.ymlを設置して
docker-compose upでbackendコンテナを起動できるようにします。

```sh
# docker-composeの作成
$\gke-django-tutorial\type nul > docker-compose.yml
```

```yaml
# docker-compose.yml
version: "3.7"

services:
  backend:
    env_file: ./backend/.env
    build: ./backend/.
    command: python /code/manage.py runserver 0.0.0.0:8000 --settings /code/config.local_settings
    volumes:
      - ./backend:/code
    ports:
      - "8000:8000"
    stdin_open: true
    tty: true
    command: python /code/manage.py runserver 0.0.0.0:8000
    environment:
      - CHOKIDAR_USEPOLLING=true
```

さっそく起動してみましょう。

```sh
$\gke-django-tutorial\docker-compose up
Building backend
Step 1/10 : FROM python:3.7
 ---> b3b677605817

=省略=

Successfully built 153021f58015
Successfully tagged gke-django-tutorial_v2_backend:latest
WARNING: Image for service backend was built because it did not already exist. To rebuild this image you must use `docker-compose build` or `docker-compose up --build`.
Creating gke-django-tutorial_v2_backend_1 ... done
Attaching to gke-django-tutorial_v2_backend_1
backend_1  | Watching for file changes with StatReloader
backend_1  | Performing system checks...
backend_1  |
backend_1  | System check identified no issues (0 silenced).
backend_1  | April 28, 2020 - 14:07:07
backend_1  | Django version 3.0.5, using settings 'config.settings'
backend_1  | Starting development server at http://0.0.0.0:8000/
backend_1  | Quit the server with CONTROL-C.
backend_1  | Session data corrupted
```

「先に`docker-compose up --build`せい」とwarningが出ましたが無事に起動できました。
`http://localhost:8000/api/`にアクセスするとDjano Rest frameworkのAPI画面が確認できます。

### frontendのDocker化

つづいてfrontendのDocker化を行います。backendと同じようにfrontendディレクトリ下にDockerfileを作成し、docker-composeで起動させたいと思います。

```sh
# docker-composeの作成
$\gke-django-tutorial\frontend\type nul > Dockerfile
# .dockerignoreの作成
$\gke-django-tutorial\frontend\type nul > .dockerignore
```

#### Dockerfile

```Dockerfile
# frontend/Dockerfile
FROM node:12.14.1

RUN mkdir /code
WORKDIR /code

# Install dependencies
COPY package.json /code/
COPY yarn.lock /code/
RUN yarn install

# Add rest of the client code
COPY . /code/

EXPOSE 3000
```

#### .dockerignore

frontend に関しては `node_modules/` が巨大であるため、これをマウントしたりコピーしたりするとかなりの時間を要します。
したがってfrontendの時と同じように`.dockerignore` を追加して node_modules をイメージビルドに使用しないようにしておきます。

```.dockerignore
/node_modules
```

#### docker-compose.yml

```yaml
# docker-compose.yml
version: "3.7"

services:
  backend:
    env_file: ./backend/.env
    build: ./backend/.
    command: python /code/manage.py runserver 0.0.0.0:8000 --settings /code/config.local_settings
    volumes:
      - ./backend:/code
    ports:
      - "8000:8000"
    stdin_open: true
    tty: true
    command: python /code/manage.py runserver 0.0.0.0:8000
    environment:
      - CHOKIDAR_USEPOLLING=true
  frontend:
    build: ./frontend/.
    volumes:
      - ./frontend:/code
      - /code/node_modules
    ports:
      - "3000:3000"
    command: yarn start
    stdin_open: true
    tty: true
    environment:
      - CHOKIDAR_USEPOLLING=true
      - NODE_ENV=development
    depends_on:
      - backend
```

frontendの`depends_on`とすることでbackendコンテナが立ち上がったあとにfrontendコンテナが
起動するようになります。

environment に`CHOKIDAR_USEPOLLING=true`を追加することでイメージを再ビルドすることなく
ホットリローディングしてくれるようになります。

さっそくビルドしてコンテナを起動し直してみます。


```sh
# docker-composeの作成
$\gke-django-tutorial\docker-compose up --build
```

ビルドに時間がかかりますが、問題なく起動することができました。
`http://localhost:3000`にアクセスすると元の画面が確認できます。

## デプロイ

こんな構造でクラスタを形成していきます。

<!-- クラスタの図 -->

### プロジェクトを作成

コンソールから新しいプロジェクトを開始します。

プロジェクト名: gke-django-tutorial
場所: 組織なし

### 課金が有効かどうかを確認する

参考 : https://cloud.google.com/billing/docs/how-to/modify-project?authuser=2

### Cloud SDKをインストールして初期化

```sh
$\gke-django-tutorial\gcloud init

Welcome! This command will take you through the configuration of gcloud.

Pick configuration to use:
 [1] Re-initialize this configuration [xxxxxx] with new settings
 [2] Create a new configuration

Please enter your numeric choice:  2

Enter configuration name. Names start with a lower case letter and
contain only lower case letters a-z, digits 0-9, and hyphens '-':  gke-django-tutorial
Your current configuration has been set to: [gke-django-tutorial]

You can skip diagnostics next time by using the following flag:
  gcloud init --skip-diagnostics

Network diagnostic detects and fixes local network connection issues.
Checking network connection...done.
Reachability Check passed.
Network diagnostic passed (1/1 checks passed).

Choose the account you would like to use to perform operations for
this configuration:
 [1] XXXX@gmail.com
 [2] XXXX@gmail.com
 [3] Log in with a new account
Please enter your numeric choice:  1

You are logged in as: [komedapeople@gmail.com].

Pick cloud project to use:
 [1] XXXXXXX
 [2] gke-django-tutorial
 [3] Create a new project
Please enter numeric choice or text value (must exactly match list
item):  2

Your current project has been set to: [gke-django-tutorial].

Not setting default zone/region (this feature makes it easier to use
[gcloud compute] by setting an appropriate default value for the
--zone and --region flag).
See https://cloud.google.com/compute/docs/gcloud-compute section on how to set
default compute region and zone manually. If you would like [gcloud init] to be
able to do this for you the next time you run it, make sure the
Compute Engine API is enabled for your project on the
https://console.developers.google.com/apis page.

Your Google Cloud SDK is configured and ready to use!

* Commands that require authentication will use komedapeople@gmail.com by default
* Commands will reference project `gke-django-tutorial` by default
Run `gcloud help config` to learn how to change individual settings

This gcloud configuration is called [gke-django-tutorial]. You can create additional configurations if you work with multiple accounts and/or projects.
Run `gcloud topic configurations` to learn more.

Some things to try next:

* Run `gcloud --help` to see the Cloud Platform services you can interact with. And run `gcloud help COMMAND` to get help on any gcloud command.
* Run `gcloud topic --help` to learn about advanced features of the SDK like arg files and output formatting


Updates are available for some Cloud SDK components.  To install them,
please run:
  $ gcloud components update



To take a quick anonymous survey, run:
  $ gcloud survey

```

### 必要なAPIを有効にする

Datastore, Pub/Sub, Cloud Storage JSON, Cloud Logging, and Google+APIs を有効にします。

### CloudSQLの準備

#### Cloud SQL Adminを有効にする

```sh
$\gke-django-tutorial\gcloud services enable sqladmin
Operation "operations/acf.652ef02f-5bbe-433c-94e5-1b11fcc0def9" finished successfully.
```

#### CloudSQL proxy

Cloud SQL Proxyをダウンロードして`cloud_sql_proxy.exe`に名前を変更します。
参考: https://cloud.google.com/python/django/kubernetes-engine#installingthecloudsqlproxy

#### インスタンスの作成

CloudSQLインスタンスを作成します。

```sh
データベースエンジンの選択: PostgreSQL
インスタンスID: websql
パスワード: gke_django_tutorial
ロケーション:
    リージョン: asia-northeast1
    ゾーン: asia-notrheast1-a
データベースのバージョン: PostgreSQL 11
```

#### インスタンスの初期化

先ほどダウンロードした`cloud_sql_proxy.exe`を使ってCloudSQLに接続するための`connectionName`を確認します。

```sh
# connecsionNameの確認
$\gke-django-tutorial\gcoud sql instances describe websql
connectionName: gke-django-tutorial:asia-northeast1:websql

# インスタンスの接続
$\gke-django-tutorial\gcoud_sql_proxy.exe -instances="gke-django-tutorial:asia-northeast1:websql"=tcp:5432
2020/04/28 17:49:51 Listening on 127.0.0.1:5432 for gke-django-tutorial:asia-northeast1:websql
2020/04/28 17:49:51 Ready for new connections
```

このコマンドによってlocal環境からCloudSQLインスタンスに接続することができました。

#### データベースの作成

コンソールからデータベースを作成しましょう。コンソール上の`websql`を選択して`データベース`から`データベースを作成`することができます。

```sh
データベース名: web-db
```

#### データベースユーザーの作成

データベースのユーザーアカウントを作成しておきます。
```sh
ユーザー名: master
パスワード: websql-pass
```

#### CloudSQLのサービスアカウントの作成

CloudSQlのサービスアカウントを作成して、json形式のプライベートキーをダウンロードしましょう。

```sh
サービスアカウント名: gke-django-tutorial-service-account
サービスアカウントID: gke-django-tutorial-service@gke-django-tutorial.iam.gservice
権限: Cloud SQL 管理者
⇒キーの作成でjson形式を選択
```

プライベートキーはプロジェクト直下に`secrets`というディレクトリを作成して設置しました。

```sh
$\gke-django-tutorial\mkdir secrets
```

#### 環境変数の設定

LocalのDjangoのデータベースをCloudSQLに設定して起動していきたいと思います。
`DATABASE_USER`と`DATABASE_PASSWORD`を環境変数として利用するため、`.env`ファイルに追加します。

```sh
SECRET_KEY='nz8t((i_mali=%0+z_g+uc**9dgky8)74slvs&6h$=9b^8t7$@'
DEBUG=False
DATABASE_USER=master
DATABASE_PASSWORD=websql-pass
```

#### Pythonパッケージの追加

DjangoからPostgresを使用するにはパッケージを追加する必要があります。
デプロイに必要なパッケージを追加しておきます。

```sh
# パッケージのインストール
(venv)$\gke-django-tutorial\backend\python -m pip install wheel gunicorn psycopg2-binary

# requirements.txtの更新
(venv)$\gke-django-tutorial\backend\python -m pip freeze > requirements.txt
```

#### backend/config/settings.py

DjangoのDATABASE設定をdb.sqlite3からCloudSQLに変更します。
`.env`ファイルを直接参照する必要があるため、`python-dotenv`を使って読み込みます。

```python
# backend/config/setting.sy

import os
from dotenv import load_dotenv  # 追加

# Build paths inside the project like this: os.path.join(BASE_DIR, ...)
BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
PROJECT_DIR = os.path.basename(BASE_DIR)

load_dotenv(os.path.join(BASE_DIR, '.env'))  # 追加

# Quick-start development settings - unsuitable for production
# See https://docs.djangoproject.com/en/3.0/howto/deployment/checklist/

# SECURITY WARNING: keep the secret key used in production secret!
SECRET_KEY = os.environ.get('SECRET_KEY')  # 変更

# SECURITY WARNING: don't run with debug turned on in production!
DEBUG = os.environ.get('DEBUG')  # 変更

DATABASES = {
    'default': {
        # If you are using Cloud SQL for MySQL rather than PostgreSQL, set
        # 'ENGINE': 'django.db.backends.mysql' instead of the following.
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': 'web-db',
        'USER': os.getenv('DATABASE_USER'),
        'PASSWORD': os.getenv('DATABASE_PASSWORD'),
        'HOST': '127.0.0.1',
        'PORT': '5432',
    }
}
```

#### マイグレーション

データベースがCloudSQLに変更したのでマイグレーションし直す必要があります。

```sh
(venv)$\gke-django-tutorial\backend\python manage.py migrate
Operations to perform:
  Apply all migrations: admin, auth, contenttypes, sessions, todo
Running migrations:
  Applying contenttypes.0001_initial... OK
  Applying auth.0001_initial... OK
  Applying admin.0001_initial... OK
  Applying admin.0002_logentry_remove_auto_add... OK
  Applying admin.0003_logentry_add_action_flag_choices... OK
  Applying contenttypes.0002_remove_content_type_name... OK
  Applying auth.0002_alter_permission_name_max_length... OK
  Applying auth.0003_alter_user_email_max_length... OK
  Applying auth.0004_alter_user_username_opts... OK
  Applying auth.0005_alter_user_last_login_null... OK
  Applying auth.0006_require_contenttypes_0002... OK
  Applying auth.0007_alter_validators_add_error_messages... OK
  Applying auth.0008_alter_user_username_max_length... OK
  Applying auth.0009_alter_user_last_name_max_length... OK
  Applying auth.0010_alter_group_name_max_length... OK
  Applying auth.0011_update_proxy_permissions... OK
  Applying sessions.0001_initial... OK
  Applying todo.0001_initial... OK
```

問題なくCloudSQLにマイグレーションすることができました。

#### 管理ユーザーの追加

同様に管理ユーザーを作成します。

```sh
(venv)$\gke-django-tutorial\backend\python manage.py createsuperuser
ユーザー名 (leave blank to use 'masayoshi'): masayoshi
メールアドレス: komedapeople@gmail.com
Password:
Password (again):
Superuser created successfully.
```

開発用サーバーを立ち上げてadminページからデータを3つほど追加しておきましょう。

```sh
(venv)$\gke-django-tutorial\backend\python manage.py runserver
```

### Cloud Storageの準備

静的ファイルをGoogle Clodu Storageに格納するための設定を行います。
ストレージを作成して静的ファイルをアップロードします。これをしないとadmin画面などのcssが反映されません。

```sh
# ストレージの作成
(venv)$\gke-django-tutorial\backend\gsutil mb gs://gke-django-storage
Creating gs://gke-django-storage/...

# 公開設定
(venv)$\gke-django-tutorial\backend\gsutil defacl set public-read gs://gke-django-storage
Setting default object ACL on gs://gke-django-storage/...
/ [1 objects]

# 静的ファイルを集める
(venv)$\gke-django-tutorial\backend\python manage.py collectstatic

# Cloud Storageに静的ファイルをアップロードする
(venv)$\gke-django-tutorial\backend\gsutil rsync -R staticfiles/ gs://gke-django-storage/static

```

`backend/config/settings.py`の`STATIC_URL`をGCSを参照するように変更します。

```python
# backend/config/settings.py
STATIC_URL = 'https://storage.googleapis.com/gke-django-storage/static/'
```

### GKEへデプロイ

クラスターを作成してコンテナをデプロイします。ServiceとIngressを設定することで外部からアクセスすることが可能になります。

#### クラスター作成

コンソールからクラスタを作成します。

```sh
クラスター名: gke-django-tutorial
ロケーションタイプ:ゾーン:asia-notrheast1-a
マスターのバージョン: 1.14.10-gke.27(デフォルト)
```

#### contextsの入手

作成したクラスターをローカルのkubectlから利用するためにcontextsを入手する。

```sh
$\gke-django-tutorial\gcloud container clusters get-credentials gke-django-tutorial --zone="asia-northeast1-a"
Fetching cluster endpoint and auth data.
kubeconfig entry generated for gke-django-tutorial.

# コンテキストが適用されているかどうかを確認する。
$\gke-django-tutorial\kubectl config current-context
gke_gke-django-tutorial_asia-northeast1-a_gke-django-tutorial
```

#### CloudSQLの設定

Secretsを作成してCloudSQLのユーザー名、パスワードを環境変数として安全に使用することができます。
GKE から Cloud SQL のインスタンスを使用するにあたって、インスタンスレベルアクセスとデータベースアクセスに関するsecrets を作成する必要があります。

参考: [インスタンスのアクセス制御]:(https://cloud.google.com/sql/docs/mysql/instance-access-control)

インスタンスレベルのアクセスについて secret を作成する。

```sh
$\gke-django-tutorial\kubectl create secret generic cloudsql-oauth-credentials --from-file=credentials.json=".\secrets\cloudsql\gke-django-tutorial-c9c425adccbd.json"

secret/cloudsql-oauth-credentials created
```

データベースへアクセスに関する secret を作成する。

```sh
$\gke-django-tutorial\kubectl create secret generic cloudsql --from-literal=username="master" --from-literal=password="master-pass"
```

#### 環境変数の設定

.envファイルに記述されている残りの`SECRET_KEY`をsecretに追加しましょう。
`DEBUG`はFalseとしておきます。

```sh
$\gke-django-tutorial\kubectl create secret generic secret-key --from-literal=SECRET_KEY="nz8t((i_mali=%0+z_g+uc**9dgky8)74slvs&6h$=9b^8t7$@"
```

`backend/config/settings.py`で関係のある個所は以下のような状態になります。

```python
# backend/config/settings.py

import os

# Build paths inside the project like this: os.path.join(BASE_DIR, ...)
BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
PROJECT_DIR = os.path.basename(BASE_DIR)

# Quick-start development settings - unsuitable for production
# See https://docs.djangoproject.com/en/3.0/howto/deployment/checklist/

# SECURITY WARNING: keep the secret key used in production secret!
SECRET_KEY = os.environ.get('SECRET_KEY')  # 変更

# SECURITY WARNING: don't run with debug turned on in production!
DEBUG = False

DATABASES = {
    'default': {
        # If you are using Cloud SQL for MySQL rather than PostgreSQL, set
        # 'ENGINE': 'django.db.backends.mysql' instead of the following.
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': 'web-db',
        'USER': os.environ.get('DATABASE_USER'),
        'PASSWORD': os.environ.get('DATABASE_PASSWORD'),
        'HOST': '127.0.0.1',
        'PORT': '5432',
    }
}

```

#### コンテナイメージの用意

ローカルでイメージをビルドしてGoogle Cloud Registryにアップロードします。
イメージ名は`gcr.io/${PROJECT}/${IMAGENAME}:${TAGNAME}`形式にする必要があります。

```sh
# プロジェクト名の確認
$\gke-django-tutorial\gcloud config get-value project
Your active configuration is: [gke-django-tutorial]
gke-django-tutorial

# イメージのビルド
# backend
$\gke-django-tutorial\docker image build --no-cache -t gcr.io/gke-django-tutorial/backend:latest ./backend

# frontend
$\gke-django-tutorial\docker image build --no-cache -t gcr.io/gke-django-tutorial/frontend:latest ./frontend

# イメージをGCRにアップロードする
# backend
$\gke-django-tutorial\gcloud docker -- push gcr.io/gke-django-tutorial/backend:latest
WARNING: `gcloud docker` will not be supported for Docker client versions above 18.03.

As an alternative, use `gcloud auth configure-docker` to configure `docker` to
use `gcloud` as a credential helper, then use `docker` as you would for non-GCR
registries, e.g. `docker pull gcr.io/project-id/my-image`. Add
`--verbosity=error` to silence this warning: `gcloud docker
--verbosity=error -- pull gcr.io/project-id/my-image`.

See: https://cloud.google.com/container-registry/docs/support/deprecation-notices#gcloud-docker

The push refers to repository [gcr.io/gke-django-tutorial/backend]
12ed78fdfd14: Pushed
485427ae6881: Pushed
bb530f6bab17: Pushed
4eae8da6dc9e: Pushed
a91544cdf6ea: Pushed
956d28316107: Layer already exists
86120ec29f78: Layer already exists
5d34cecc2826: Layer already exists
baf481fca4b7: Layer already exists
3d3e92e98337: Layer already exists
8967306e673e: Layer already exists
9794a3b3ed45: Layer already exists
5f77a51ade6a: Layer already exists
e40d297cf5f8: Layer already exists
latest: digest: sha256:3905957cfddea8454288b460adf8b134d0de1bc0791dbc8cf3fe7b9e6012512f size: 3267

# frontend
$\gke-django-tutorial\gcloud docker -- push gcr.io/gke-django-tutorial/frontend:latest
WARNING: `gcloud docker` will not be supported for Docker client versions above 18.03.

As an alternative, use `gcloud auth configure-docker` to configure `docker` to
use `gcloud` as a credential helper, then use `docker` as you would for non-GCR
registries, e.g. `docker pull gcr.io/project-id/my-image`. Add
`--verbosity=error` to silence this warning: `gcloud docker
--verbosity=error -- pull gcr.io/project-id/my-image`.

See: https://cloud.google.com/container-registry/docs/support/deprecation-notices#gcloud-docker

The push refers to repository [gcr.io/gke-django-tutorial/frontend]
c6c151685fbb: Pushed
ef3845fc4e9d: Pushed
069d14dab7a7: Pushed
a3a63dfb31f4: Pushed
2fcc481d7fdd: Pushed
203542cdccd7: Pushed
37d4010f40f0: Pushed
f895d244bc8e: Pushed
03dc1830d2d5: Pushed
1d7382716a27: Pushed
01727b1a72df: Layer already exists
69dfa7bd7a92: Layer already exists
4d1ab3827f6b: Layer already exists
7948c3e5790c: Layer already exists
latest: digest: sha256:26d0836290483f2f58141db9bd18a66a5c5b99a3ce9da3643679592d0d8bb5ec size: 3261

```

#### Frontendのデプロイ

FrontendのDeploymentを作成してデプロイします。deploymentとして`frontend-react.yml`というファイルを作成します。

```sh
$\gke-django-tutorial\type nul > frontend-deployment.yml
```

```yml
# frontend-deployment.yml
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: frontend
  labels:
    app: frontend
spec:
  replicas: 1
  template:
    metadata:
      labels:
        app: frontend
    spec:
      containers:
        - name: frontend
          image: gcr.io/gke-django-tutorial/frontend:latest
          imagePullPolicy: Always
          command: ["npm", "start"]
          ports:
          - containerPort: 3000

```

```sh
$\gke-django-tutorial\kubectl create -f frontend-deployment.yml
deployment.extensions/frontend created

# 確認
$\gke-django-tutorial\kubectl get pods
NAME                        READY   STATUS              RESTARTS   AGE
frontend-77f75d4c47-45j4q   0/1     ContainerCreating   0          27s
```

```sh
$ kubectl logs ~~

> frontend@0.1.0 start /code
> react-scripts start

[34mℹ[39m [90m｢wds｣[39m: Project is running at http://10.24.0.8/
[34mℹ[39m [90m｢wds｣[39m: webpack output is served from
[34mℹ[39m [90m｢wds｣[39m: Content not from webpack is served from /code/public
[34mℹ[39m [90m｢wds｣[39m: 404s will fallback to /
Starting the development server...
```

#### Backendのデプロイ

frontendと同じようにbackendのDeploymentを作成してデプロイします。
`backend-deployment.yml`を作成します。

```sh
$\gke-django-tutorial\type nul > backend-deployment.yml
```



#### 
