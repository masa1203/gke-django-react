# GKE ã« Django+React ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹

## ã‚„ã‚ŠãŸã„ã“ã¨

Docker ã§ç’°å¢ƒæ§‹ç¯‰ã—ã¦ k8s ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸã„ã€‚
ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¯ DjangoRestFramework ã§ RestAPI ã‚’é…ä¿¡ã—ã¦ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¯ React(TypeScript)ã§å®Ÿè£…ã—ãŸã„ã€‚

## ç’°å¢ƒ

```sh
node --version
v12.14.1

npm --version
6.13.7

python --version
Python 3.7.4

docker --version
Docker version 19.03.8
```

1. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã™ã‚‹
   ãƒ­ãƒ¼ã‚«ãƒ«ã§èµ·å‹•ã§ãã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹

2. GCP ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã™ã‚‹
   CloudSQL, CloudStorage ã‚’ä½¿ã£ã¦ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰ã‚¯ãƒ©ã‚¦ãƒ‰ã®ãƒãƒãƒ¼ã‚¸ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã‚’åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚

3. Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½œæˆã™ã‚‹
   ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½œæˆã™ã‚‹ã€‚.env ã¯çœã„ãŸæ–¹ãŒè‰¯ã„ãŒã“ã‚Œã¯ã¾ã å¯¾å¿œã—ã¦ã„ãªã„ã€‚

4. GKE ã®ã‚¯ãƒ©ã‚¹ã‚¿ã‚’ä½œæˆã™ã‚‹
   ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é–‹å§‹ã—ã¦ GKE ã‚¯ãƒ©ã‚¹ã‚¿ã‚’ä½œæˆã™ã‚‹ã€‚

5. Deployment ã‚’ä½œæˆã™ã‚‹
   backend ã® Secret ã‚’ä½œæˆã—ã¦ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«åˆ©ç”¨ã€‚

6. Service ã‚’ä½œæˆã™ã‚‹
   backend ã¨ frontend

7. Ingress ã‚’ä½œæˆã™ã‚‹

8. ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã«å¯¾å¿œã™ã‚‹
   ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã«å¯¾å¿œã™ã‚‹ã€‚
   é™çš„ã‚¢ãƒ‰ãƒ¬ã‚¹ã«è¿½åŠ ã™ã‚‹ã€‚200 ã‚’è¿”ã™ã‚ˆã†ã« view ã‚’è¿½åŠ ã€‚

9. DNS ã«å¯¾å¿œã™ã‚‹
   ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’å–å¾—ã—ã¦ ingress ã« host ã‚’è¿½åŠ ã€‚

10. HTTPS åŒ–
    https://qiita.com/watiko/items/71d78a4d31eee02cb47d

## ã¾ãšã¯ãƒ­ãƒ¼ã‚«ãƒ«ã§å§‹ã‚ã‚‹

### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã™ã‚‹ã€‚

```sh
# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€ã®ä½œæˆ
$ mkdir gke-django-tutorial
$ cd gke-django-tutorial
# ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã™ã‚‹
$\gke-django-tutorial\mkdir backend
$\gke-django-tutorial\mkdir frontend
```

### Backend ã®é–‹ç™ºã‚’å§‹ã‚ã‚‹

backend ã¯ Djang-rest-framework ã§ RestAPI ã‚’ä½œæˆã—ã¾ã™ã€‚
ã¾ãšã¯ backend ã‹ã‚‰ç’°å¢ƒã‚’ä½œæˆã—ã¦ã¿ã¾ã™ã€‚

```sh
# backendãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
$\gke-django-tutorial\cd backend
# Pythonã®ä»®æƒ³ç’°å¢ƒä½œæˆ
$\gke-django-tutorial\backend\python -m venv venv
# ä»®æƒ³ç’°å¢ƒã®æœ‰åŠ¹åŒ–
$\gke-django-tutorial\backend\vnev\Scripts\activate
# Pythonãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
(venv)$\gke-django-tutorial\backend\python -m install --upgrade pip setuptools
(venv)$\gke-django-tutorial\backend\python -m install django djangorestframework python-dotenv
# Djangoã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å§‹ã‚ã‚‹
(venv)$\gke-django-tutorial\backend\django-admin startproject config .
```

backend ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä¸‹ã§`django-admin startprject config .`ã¨ã™ã‚‹ã“ã¨ã§
`config`ã¨ã„ã† Django ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€ãŒä½œæˆã•ã‚Œã¾ã—ãŸã€‚

ãƒ­ãƒ¼ã‚«ãƒ«ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã™ã‚‹ã‹ã©ã†ã‹ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚

```sh
(venv)$\gke-django-tutorial\backend\python manage.py runserver
Watching for file changes with StatReloader
Performing system checks...

System check identified no issues (0 silenced).

You have 17 unapplied migration(s). Your project may not work properly until you apply the migrations for app(s): admin, auth, contenttypes, sessions.
Run 'python manage.py migrate' to apply them.
April 27, 2020 - 11:22:06
Django version 3.0.5, using settings 'config.settings'
Starting development server at http://127.0.0.1:8000/
Quit the server with CTRL-BREAK.
```

é–‹ç™ºç”¨ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ãŸã®ã§`http://localhost:8000/`ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨`The install worked successfully!`ã®ç”»é¢ãŒç¢ºèªã§ãã¾ã™ã€‚

#### settings.py

`config/settings.py`ã‚’ç·¨é›†ã—ã¦åŸºæœ¬çš„ãªè¨­å®šã‚’ç››ã‚Šè¾¼ã¿ã¾ã™ã€‚
settings.py ã®ç§˜åŒ¿ã™ã¹ãæƒ…å ±ã¯`.env`ãƒ•ã‚¡ã‚¤ãƒ«ã«è¨˜è¿°ã—ã¦å…¬é–‹ã—ãªã„ã‚ˆã†ã«ã—ã¾ã™ã€‚
python-dotenv ã‚’ä½¿ã£ã¦`.env`ã«è¨˜è¼‰ã•ã‚ŒãŸæƒ…å ±ã‚’åˆ©ç”¨ã™ã‚‹ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã—ã‚‡ã†ã€‚

```sh
# .envãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ
(venv)$\gke-django-tutorial\backend\type null > .env
```

```python:config.settins.py
# config/settings.py

"""
Django settings for config project.

Generated by 'django-admin startproject' using Django 3.0.5.

For more information on this file, see
https://docs.djangoproject.com/en/3.0/topics/settings/

For the full list of settings and their values, see
https://docs.djangoproject.com/en/3.0/ref/settings/
"""

import os
from dotenv import load_dotenv  # è¿½åŠ 

# Build paths inside the project like this: os.path.join(BASE_DIR, ...)
BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
PROJECT_DIR = os.path.basename(BASE_DIR)  # è¿½åŠ 

# .envã®èª­ã¿è¾¼ã¿
load_dotenv(os.path.join(BASE_DIR, '.env'))  # è¿½åŠ 

# Quick-start development settings - unsuitable for production
# See https://docs.djangoproject.com/en/3.0/howto/deployment/checklist/

# SECURITY WARNING: keep the secret key used in production secret!
SECRET_KEY = os.getenv('SECRET_KEY')

# SECURITY WARNING: don't run with debug turned on in production!
DEBUG = os.getenv('DEBUG')

ALLOWED_HOSTS = ["*"]  # å¤‰æ›´


# Application definition

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
]

MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]

ROOT_URLCONF = 'config.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [os.path.join(BASE_DIR, 'templates')],  # å¤‰æ›´
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

WSGI_APPLICATION = 'config.wsgi.application'


# Database
# https://docs.djangoproject.com/en/3.0/ref/settings/#databases

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': os.path.join(BASE_DIR, 'db.sqlite3'),
    }
}


# Password validation
# https://docs.djangoproject.com/en/3.0/ref/settings/#auth-password-validators

AUTH_PASSWORD_VALIDATORS = [
    {
        'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
    },
]


# Internationalization
# https://docs.djangoproject.com/en/3.0/topics/i18n/

LANGUAGE_CODE = 'ja'  # å¤‰æ›´

TIME_ZONE = 'Asia/Tokyo'

USE_I18N = True

USE_L10N = True

USE_TZ = True


# Static files (CSS, JavaScript, Images)
# https://docs.djangoproject.com/en/3.0/howto/static-files/

STATIC_URL = '/static/'


# é–‹ç™ºç’°å¢ƒä¸‹ã§é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‚ç…§ã™ã‚‹å…ˆ
STATICFILES_DIRS = [os.path.join(BASE_DIR, 'static')] # è¿½åŠ 

# æœ¬ç•ªç’°å¢ƒã§é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‚ç…§ã™ã‚‹å…ˆ
STATIC_ROOT = os.path.join(BASE_DIR, 'staticfiles') # è¿½åŠ 

# ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ•ã‚¡ã‚¤ãƒ«path
MEDIA_URL = '/media/' # è¿½åŠ 

```

```sh:.env
# .env
SECRET_KEY = 'nz8t((i_mali=%0+z_g+uc**9dgky8)74slvs&6h$=9b^8t7$@'
DEBUG = False
```

#### ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã™ã‚‹

todo ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œã£ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

```sh
(venv)$\gke-django-tutorial\backend\python manage.py startapp todo
```

`config/settings.py` ã®`INSTALLED_APPS`ã«`todo`ã¨`rest_framework`ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```python
# config/settings.py

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',

    # 3rd party
    'rest_framework',

    # Local
    'todo.apps.TodoConfig',
]

# è¿½åŠ 
REST_FRAMEWORK = {
    'DEFAULT_PERMISSION_CLASSES': [
        'rest_framework.permissions.AllowAny',
    ]
}

```
`rest_framework.permissions.AllowAny`ã¯ django-rest-framework ãŒæš—é»™çš„ã«æ±ºã‚ã¦ã„ã‚‹ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®è¨­å®š`'DEFAULT_PERMISSION_CLASSES'`ã‚’è§£é™¤ã™ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã™ã€‚
ã“ã®è¨­å®šã¯ã¾ã ã‚ˆãã‚ã‹ã£ã¦ãªã„ã®ã§ã™ãŒã¨ã‚Šã‚ãˆãšå‰ã«é€²ã¿ã¾ã™ã€‚

#### todo/models.py

`todo`ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ model ã‚’ä½œæˆã—ã¾ã™ã€‚

```python
# todo/models.py
from django.db import models


class Todo(models.Model):
    title = models.CharField(max_length=200)
    body = models.TextField()

    def __str__(self):
        return self.title

```

`todo/admin.py`ã«ä½œæˆã—ãŸãƒ¢ãƒ‡ãƒ«ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```python
# todo/admin.py
from django.contrib import admin
from .models import Todo


admin.site.register(Todo)
```

ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã—ã¾ã™ã€‚

```sh
(venv)$\gke-django-tutorial\backend\python manage.py makemigrations
Migrations for 'todo':
  todo\migrations\0001_initial.py
    - Create model Todo

(venv)$\gke-django-tutorial\backend\python manage.py migrate
Operations to perform:
  Apply all migrations: admin, auth, contenttypes, sessions, todo
Running migrations:
  Applying contenttypes.0001_initial... OK
  Applying auth.0001_initial... OK
  Applying admin.0001_initial... OK
  Applying admin.0002_logentry_remove_auto_add... OK
  Applying admin.0003_logentry_add_action_flag_choices... OK
  Applying contenttypes.0002_remove_content_type_name... OK
  Applying auth.0002_alter_permission_name_max_length... OK
  Applying auth.0003_alter_user_email_max_length... OK
  Applying auth.0004_alter_user_username_opts... OK
  Applying auth.0005_alter_user_last_login_null... OK
  Applying auth.0006_require_contenttypes_0002... OK
  Applying auth.0007_alter_validators_add_error_messages... OK
  Applying auth.0008_alter_user_username_max_length... OK
  Applying auth.0009_alter_user_last_name_max_length... OK
  Applying auth.0010_alter_group_name_max_length... OK
  Applying auth.0011_update_proxy_permissions... OK
  Applying sessions.0001_initial... OK
  Applying todo.0001_initial... OK
```

#### createsuperuser

ç®¡ç†è€…ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã—ã¾ã™ã€‚

```sh
(venv)$\gke-django-tutorial\backend\python manage.py createsuperuser
ãƒ¦ãƒ¼ã‚¶ãƒ¼å (leave blank to use 'you'): admin
ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹: XXXXX@gmail.com
Password:
Password (again):
Superuser created successfully.
```

é–‹ç™ºç”¨ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¦`http://localhost:8000/admin`ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨
Djangoç®¡ç†ã‚µã‚¤ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
å…ˆã»ã©è¨­å®šã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼åã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

ä½œæˆã—ãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³`Todo`ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ç¢ºèªã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
2ï¼Œ3ã‚³ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¿½åŠ ã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚

#### URLs

`config/urls.py`ã« todo ã¸ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```python
# config/urls.py

from django.contrib import admin
from django.urls import path, include

urlpatterns = [
    path('admin/', admin.site.urls),
    path('api/', include('todo.urls'))  # è¿½åŠ 
]

```

#### todo/urls.py

`todos/urls.py`ã‚’ä½œæˆã—ã¾ã™ã€‚

```sh
(venv)$\gke-django-tutorial\backend\type null > todo\urls.py
```

```python
# todo/urls.py
from django.urls import path, include
from .views import ListTodo, DetailTodo

urlpatterns = [
    path('<int:pk>', DetailTodo.as_view()),
    path('', ListTodo.as_view())
]
```

#### todo/selializers.py

ãƒ¢ãƒ‡ãƒ«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç°¡å˜ã«jsonå½¢å¼ã«å¤‰æ›ã™ã‚‹ãŸã‚ã®ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼ã‚’ä½œæˆã—ã¾ã™ã€‚

```sh
(venv)$\gke-django-tutorial\backend\type null > todo\serializers.py
```

```python
# todo/serializers.py
from rest_framework import serializers
from .models import Todo


class TodoSerializer(serizers.ModelSerializer):
    class Meta:
        model = Todo
        fields = ('id', 'title', 'body')

```

`fields = ('id', 'title', 'text')`ã§ã®`id`ã¯ PrimaryKey ã‚’æŒ‡å®šã—ãªã„å ´åˆã€
Django ã«ã‚ˆã£ã¦è‡ªå‹•çš„ã«è¿½åŠ ã•ã‚Œã¾ã™ã€‚

#### todo/views.py

Django Rest Frameworkã§`views.py`ã‚’ä½œæˆã™ã‚‹å ´åˆã¯`rest_framework.generics`ã®APIViewã‚’ç¶™æ‰¿ã—ã¾ã™ã€‚

```python
# todo/views.py

from django.shortcuts import render
from rest_framework import generics
from .models import Todo
from .serializers import TodoSerializer


class ListTodo(generics.ListAPIView):
    queryset = Todo.objects.all()
    serializer_class = TodoSerializer


class DetailTodo(generics.RetrieveAPIView):
    queryset = Todo.objects.all()
    serializer_class = TodoSerializer
```

router ãªã©è¨­å®šã§ãã¦ã„ã¾ã›ã‚“ãŒã€ã¨ã‚Šã‚ãˆãšã¯ Todo ã‚¢ã‚¤ãƒ†ãƒ ã‚’ API ã¨ã—ã¦ä½¿ç”¨ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚
é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã§`http://127.0.0.1:8000/api/`ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ APIview ã‚’ç¢ºèªã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ã“ã“ã¾ã§ã¯ Django ã§ã‚ˆãã‚ã‚‹ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ã®é–‹ç™ºã§ã™ã€‚

#### CORS

CORS(Cross-Origin Resource Sharing)ã¯ React ã¨ Django ã‚’é€£æºã•ã›ã‚‹å ´åˆã€
React ã‚’èµ·å‹•ã—ãŸ`localhost:3000`ã¯ Django ã® API ã‚µãƒ¼ãƒãƒ¼`localhost:8000`ã¨
json ã®ã‚„ã‚Šå–ã‚Šã‚’è¡Œã‚ã›ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã™ã€‚
`django-cors-headers`ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã—ã‚‡ã†ã€‚

```sh
(venv)$\gke-django-tutorial\backend\python -m pip install django-cors-headers
```

`config/settings.py`ã‚’æ›´æ–°ã—ã¾ã™ã€‚

```python
# config/settings.py

# Application definition

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',

    # 3rd party
    'rest_framework',
    'corsheaders',

    # Local
    'todos.apps.TodosConfig',
]

MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'corsheaders.middleware.CorsMidddleware',  # è¿½åŠ 
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]

##################
# rest_framework #
##################

REST_FRAMEWORK = {
    'DEFAULT_PERMISSION_CLASSES': [
        'rest_framework.permissions.AllowAny',
    ]
}

CORS_ORIGIN_WHITELIST = (
    'http://localhost:3000',
)
```

#### local_settings.py

`config/settings.py`ã¯æœ¬ç•ªç’°å¢ƒã«ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚’è€ƒæ…®ã—ã€`config/local_settings.py`ã‚’ä½œæˆã—ã¦ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç”¨ã«åˆ†ã‘ã¦ãŠãã¾ã™ã€‚
GKEãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«ã¯CloudSQLã‚’ä½¿ç”¨ã—ã€ãƒ­ãƒ¼ã‚«ãƒ«ã§ã¯sqlite3ã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«ã€settings.pyã‚’åˆ†ã‘ã¦ãŠãã“ã¨ã§è¨­å®šå€¤ã‚’æ›¸ãæ›ãˆãšã«æ¸ˆã¿ã¾ã™ã€‚

```sh
# ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ
(venv)$\gke-django-tutorial\backend\type null > config/local_settings.py
```

```python
# config/local_settings.py
from .settings import *

DEBUG = True

ALLOWED_HOSTS = ['*']

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': os.path.join(BASE_DIR, 'db.sqlite3'),
    }
}
```

`config/local_settings.py`ã‚’ä½¿ã£ã¦é–‹ç™ºç”¨ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¦ãŠãã¾ã™ã€‚

```sh
(venv)$\gke-django-tutorial\backend\python manage.py runserver --settings config.local_settings
```

#### Tests

ãƒ†ã‚¹ãƒˆã‚’æ›¸ãã¾ã™ã€‚

```python
# todos/test.py

from django.test import TestCase
from .models import Todo


class TodoModelTest(TestCase):

    @classmethod
    def setUpTestData(cls):
        Todo.objects.create(title="first todo", body="a body here")

    def test_title_content(self):
        todo = Todo.objects.get(id=1)
        excepted_object_name = f'{todo.title}'
        self.assertEqual(excepted_object_name, 'first todo')

    def test_body_content(self):
        todo = Todo.objects.get(id=1)
        excepted_object_name = f'{todo.body}'
        self.assertEqual(excepted_object_name, 'a body here')

```

```sh
(venv)$\gke-django-tutorial\backend\ python manage.py test
Creating test database for alias 'default'...
System check identified no issues (0 silenced).
..
----------------------------------------------------------------------
Ran 2 tests in 0.007s

OK
Destroying test database for alias 'default'...
```

ã†ã¾ãã„ã£ãŸã‚ˆã†ã§ã™ã€‚

#### é™çš„ãƒ•ã‚¡ã‚¤ãƒ«

é…ä¿¡å¾Œã«ç®¡ç†è€…æ©Ÿèƒ½ã®cssãŒåæ˜ ã•ã‚Œã‚‹ã‚ˆã†ã«é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é›†ç´„ã—ã¦ãŠãã¾ã™ã€‚

```sh
# é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ç”¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
(venv)$\gke-django-tutorial\backend\mkdir static
# é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã®é›†ç´„
(venv)$\gke-django-tutorial\backend\python manage.py collectstatic
```

#### requirements.txt

ä»®æƒ³ç’°å¢ƒã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸPythonãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’requirements.txtã«ã¾ã¨ã‚ã¦ãŠãã¾ã™ã€‚

```sh
# é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ç”¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
(venv)$\gke-django-tutorial\backend\python -m pip freeze > requirements.txt
```

å®Ÿè¡Œã™ã‚‹ã¨backend/ä¸‹ã«requirements.txtãŒä½œæˆã•ã‚Œã¾ã™ã€‚

```txt
asgiref==3.2.7
Django==3.0.5
django-cors-headers==3.2.1
djangorestframework==3.11.0
python-dotenv==0.13.0
pytz==2019.3
sqlparse==0.3.1
```

### Frontendã®é–‹ç™ºã‚’é€²ã‚ã‚‹

æ–°ã—ã„ã‚³ãƒãƒ³ãƒ‰ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’é–‹ã„ã¦Reactã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é–‹å§‹ã—ã¦ã„ãã¾ã™ã€‚

```sh
# ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä¸‹ã«Reactãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ãŸã¦ã‚‹
$\gke-django-tutorial\frontend\npx create-react-app .
# Reactã®é–‹ç™ºç”¨ã‚µãƒ¼ãƒãƒ¼ã‚’ç«‹ã¡ä¸Šã’ã‚‹
$\gke-django-tutorial\frontend\yarn start
yarn run v1.22.0
$ react-scripts start
i ï½¢wdsï½£: Project is running at http://192.168.11.8/
i ï½¢wdsï½£: webpack output is served from
i ï½¢wdsï½£: Content not from webpack is served from C:\Users\masayoshi\docker_project\gke-django-tutorial_v2\frontend\public
i ï½¢wdsï½£: 404s will fallback to /
Starting the development server...
Compiled successfully!

You can now view frontend in the browser.

  Local:            http://localhost:3000
  On Your Network:  http://192.168.11.8:3000

Note that the development build is not optimized.
To create a production build, use yarn build.
```

`http://localhost:3000`ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨Reactã®Welcomeãƒšãƒ¼ã‚¸ãŒç¢ºèªã§ãã¾ã™ã€‚

APIã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹ã®ã«ã¯`axios`ã‚’ä½¿ã„ã¾ã™ã€‚

```sh
# ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
$\gke-django-tutorial\frontend\yarn add axios
```

#### App.js
APIã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯ä»¥ä¸‹ã®ã‚ˆã†ãªå½¢ã§APIã‚’è¿”ã—ã¦ãã¾ã™ã€‚

```javascript
// src/App.js
import React from 'react';
import axios from "axios";
import './App.css';

class App extends Component {
  state = {
    todo: []
  };

  componentDidMount() {
    this.getTodos();
  }

  getTodos() {
    axios
      .get("http://localhost:8000/api/")
      .then(res => {
        this.setState({ todo: res.data });
      })
      .catch(err => {
        console.log(err);
      });
  }
  render() {
    return (
      <div>
        {this.state.todo.map(item => (
          <div key={item.id}>
            <h1>{item.title}</h1>
            <p>{item.body}</p>
          </div>
        ))}
      </div>
    );
  }
}

export default App;

```

ã“ã‚Œãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§fronendã‹ã‚‰barckendã¸ã®apiã‚’å©ã„ã¦todoãƒªã‚¹ãƒˆä¸€è¦§ã‚’è¡¨ç¤ºã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚

## DockeråŒ–

æ¬¡ã¯ã“ã‚Œã‚’DockeråŒ–ã—ã¦ã„ãã¾ã™ã€‚
frontend, backendãã‚Œãã‚Œã«Dockerfileã‚’ä½œæˆã—ã¦backendã‚³ãƒ³ãƒ†ãƒŠã€frontendã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œæˆã—ã¾ã™ã€‚
é–‹ç™ºç’°å¢ƒã¯docker-composeã§æ§‹ç¯‰ã™ã‚‹ã‚ˆã†ã«é€²ã‚ã¦ã„ãã¾ã™ã€‚

docker-composeã§ç«‹ã¡ä¸Šã’ã‚‰ã‚Œã‚‹ã¨ã“ã‚ã¾ã§ã‚’è€ƒãˆã¦ã„ãã¾ã™ã€‚

### backendã®DockeråŒ–

#### settings.py

backendã‚’dockerã‚³ãƒ³ãƒ†ãƒŠåŒ–ã™ã‚‹éš›ã«ç’°å¢ƒå¤‰æ•°ã¯`.env`ã§æŒ‡å®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ã“ã‚Œã¾ã§ã¯`python-dotenv`ã§`.env`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‚ç…§ã—ã¦ã„ã¾ã—ãŸãŒã€ç’°å¢ƒå¤‰æ•°ã‚’å‚ç…§ã™ã‚‹ã‚ˆã†ã«
å¤‰æ›´ã—ã¾ã—ã‚‡ã†ã€‚

ã¾ãšã¯`config/local_settings.py`ã‚’å¤‰æ›´ã—ã¾ã™ã€‚

```python
# config/local_settings.py
from .settings import *

SECRET_KEY = os.environ.get('SECRET_KEY')  # è¿½åŠ 

DEBUG = True

ALLOWED_HOSTS = ['*']

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': os.path.join(BASE_DIR, 'db.sqlite3'),
    }
}
```

```python
# config/settings.py
import os

# SECURITY WARNING: keep the secret key used in production secret!
SECRET_KEY = os.environ.get('SECRET_KEY')  # å¤‰æ›´

# SECURITY WARNING: don't run with debug turned on in production!
DEBUG = os.environ.get('DEBUG')  # å¤‰æ›´

```

GKEãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«ã¯CloudSQLã‚’ä½¿ç”¨ã—ã¾ã™ã€‚ãã®æ™‚ã«DATABASEéƒ¨åˆ†ã¯å¤‰æ›´ã—ã¾ã™ã€‚

#### Dockerfile

Dockerfileã‚’ä½œã£ã¦ã„ãã¾ã™ã€‚

```sh
# Dockerfileã®ä½œæˆ
$\gke-django-tutorial\backend\type null > Dockerfile
```

```Dockerfile
# backend/Dockerfile

# set base image
FROM python:3.7

# set environment variables
ENV PYTHONDONTWRITEBYTECODE 1
ENV PYTHONUNBUFFERED 1

# set work directory
RUN mkdir /code
WORKDIR /code

# install dependencies
COPY requirements.txt /code/
RUN python3 -m pip install --upgrade pip setuptools
RUN pip install -r requirements.txt

# Copy project
COPY . /code/

EXPOSE 8000

```

#### .dockerignore

ã“ã®ã¾ã¾ã ã¨ç§˜åŒ¿ã™ã‚‹ã¹ã`.env`ãƒ•ã‚¡ã‚¤ãƒ«ã‚‚ä¸€ç·’ã«ã‚³ãƒ”ãƒ¼ã•ã‚Œã¦ã—ã¾ã„ã¾ã™ã€‚
`.dockerignore`ã‚’è¿½åŠ ã—ã¦`.env`ãŒè¿½åŠ ã•ã‚Œãªã„ã‚ˆã†ã«ã—ã¾ã™ã€‚

```sh
$\gke-django-tutorial\backend\type nul > .dockerignore
```

```dockerfile
# .dockerignore
.env
```

#### docker-compose.yml

æ¬¡ã«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«docker-compose.ymlã‚’è¨­ç½®ã—ã¦
docker-compose upã§backendã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

```sh
# docker-composeã®ä½œæˆ
$\gke-django-tutorial\type nul > docker-compose.yml
```

```yaml
# docker-compose.yml
version: "3.7"

services:
  backend:
    env_file: ./backend/.env
    build: ./backend/.
    command: python /code/manage.py runserver 0.0.0.0:8000 --settings /code/config.local_settings
    volumes:
      - ./backend:/code
    ports:
      - "8000:8000"
    stdin_open: true
    tty: true
    command: python /code/manage.py runserver 0.0.0.0:8000
    environment:
      - CHOKIDAR_USEPOLLING=true
```

ã•ã£ããèµ·å‹•ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```sh
$\gke-django-tutorial\docker-compose up
Building backend
Step 1/10 : FROM python:3.7
 ---> b3b677605817

=çœç•¥=

Successfully built 153021f58015
Successfully tagged gke-django-tutorial_v2_backend:latest
WARNING: Image for service backend was built because it did not already exist. To rebuild this image you must use `docker-compose build` or `docker-compose up --build`.
Creating gke-django-tutorial_v2_backend_1 ... done
Attaching to gke-django-tutorial_v2_backend_1
backend_1  | Watching for file changes with StatReloader
backend_1  | Performing system checks...
backend_1  |
backend_1  | System check identified no issues (0 silenced).
backend_1  | April 28, 2020 - 14:07:07
backend_1  | Django version 3.0.5, using settings 'config.settings'
backend_1  | Starting development server at http://0.0.0.0:8000/
backend_1  | Quit the server with CONTROL-C.
backend_1  | Session data corrupted
```

ã€Œå…ˆã«`docker-compose up --build`ã›ã„ã€ã¨warningãŒå‡ºã¾ã—ãŸãŒç„¡äº‹ã«èµ·å‹•ã§ãã¾ã—ãŸã€‚
`http://localhost:8000/api/`ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨Djano Rest frameworkã®APIç”»é¢ãŒç¢ºèªã§ãã¾ã™ã€‚

### frontendã®DockeråŒ–

ã¤ã¥ã„ã¦frontendã®DockeråŒ–ã‚’è¡Œã„ã¾ã™ã€‚backendã¨åŒã˜ã‚ˆã†ã«frontendãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä¸‹ã«Dockerfileã‚’ä½œæˆã—ã€docker-composeã§èµ·å‹•ã•ã›ãŸã„ã¨æ€ã„ã¾ã™ã€‚

```sh
# docker-composeã®ä½œæˆ
$\gke-django-tutorial\frontend\type nul > Dockerfile
# .dockerignoreã®ä½œæˆ
$\gke-django-tutorial\frontend\type nul > .dockerignore
```

#### Dockerfile

```Dockerfile
# frontend/Dockerfile
FROM node:12.14.1

RUN mkdir /code
WORKDIR /code

# Install dependencies
COPY package.json /code/
COPY yarn.lock /code/
RUN yarn install

# Add rest of the client code
COPY . /code/

EXPOSE 3000
```

#### .dockerignore

frontend ã«é–¢ã—ã¦ã¯ `node_modules/` ãŒå·¨å¤§ã§ã‚ã‚‹ãŸã‚ã€ã“ã‚Œã‚’ãƒã‚¦ãƒ³ãƒˆã—ãŸã‚Šã‚³ãƒ”ãƒ¼ã—ãŸã‚Šã™ã‚‹ã¨ã‹ãªã‚Šã®æ™‚é–“ã‚’è¦ã—ã¾ã™ã€‚
ã—ãŸãŒã£ã¦frontendã®æ™‚ã¨åŒã˜ã‚ˆã†ã«`.dockerignore` ã‚’è¿½åŠ ã—ã¦ node_modules ã‚’ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ã«ä½¿ç”¨ã—ãªã„ã‚ˆã†ã«ã—ã¦ãŠãã¾ã™ã€‚

```.dockerignore
/node_modules
```

#### docker-compose.yml

```yaml
# docker-compose.yml
version: "3.7"

services:
  backend:
    env_file: ./backend/.env
    build: ./backend/.
    command: python /code/manage.py runserver 0.0.0.0:8000 --settings /code/config.local_settings
    volumes:
      - ./backend:/code
    ports:
      - "8000:8000"
    stdin_open: true
    tty: true
    command: python /code/manage.py runserver 0.0.0.0:8000
    environment:
      - CHOKIDAR_USEPOLLING=true
  frontend:
    build: ./frontend/.
    volumes:
      - ./frontend:/code
      - /code/node_modules
    ports:
      - "3000:3000"
    command: yarn start
    stdin_open: true
    tty: true
    environment:
      - CHOKIDAR_USEPOLLING=true
      - NODE_ENV=development
    depends_on:
      - backend
```

frontendã®`depends_on`ã¨ã™ã‚‹ã“ã¨ã§backendã‚³ãƒ³ãƒ†ãƒŠãŒç«‹ã¡ä¸ŠãŒã£ãŸã‚ã¨ã«frontendã‚³ãƒ³ãƒ†ãƒŠãŒ
èµ·å‹•ã™ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

environment ã«`CHOKIDAR_USEPOLLING=true`ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã§ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å†ãƒ“ãƒ«ãƒ‰ã™ã‚‹ã“ã¨ãªã
ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã—ã¦ãã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

ã•ã£ãããƒ“ãƒ«ãƒ‰ã—ã¦ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ã—ç›´ã—ã¦ã¿ã¾ã™ã€‚


```sh
# docker-composeã®ä½œæˆ
$\gke-django-tutorial\docker-compose up --build
```

ãƒ“ãƒ«ãƒ‰ã«æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™ãŒã€å•é¡Œãªãèµ·å‹•ã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚
`http://localhost:3000`ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨å…ƒã®ç”»é¢ãŒç¢ºèªã§ãã¾ã™ã€‚

## ãƒ‡ãƒ—ãƒ­ã‚¤

ã“ã‚“ãªæ§‹é€ ã§ã‚¯ãƒ©ã‚¹ã‚¿ã‚’å½¢æˆã—ã¦ã„ãã¾ã™ã€‚

<!-- ã‚¯ãƒ©ã‚¹ã‚¿ã®å›³ -->

### ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ

ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰æ–°ã—ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é–‹å§‹ã—ã¾ã™ã€‚

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå: gke-django-tutorial
å ´æ‰€: çµ„ç¹”ãªã—

### èª²é‡‘ãŒæœ‰åŠ¹ã‹ã©ã†ã‹ã‚’ç¢ºèªã™ã‚‹

å‚è€ƒ : https://cloud.google.com/billing/docs/how-to/modify-project?authuser=2

### Cloud SDKã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦åˆæœŸåŒ–

```sh
$\gke-django-tutorial\gcloud init

Welcome! This command will take you through the configuration of gcloud.

Pick configuration to use:
 [1] Re-initialize this configuration [xxxxxx] with new settings
 [2] Create a new configuration

Please enter your numeric choice:  2

Enter configuration name. Names start with a lower case letter and
contain only lower case letters a-z, digits 0-9, and hyphens '-':  gke-django-tutorial
Your current configuration has been set to: [gke-django-tutorial]

You can skip diagnostics next time by using the following flag:
  gcloud init --skip-diagnostics

Network diagnostic detects and fixes local network connection issues.
Checking network connection...done.
Reachability Check passed.
Network diagnostic passed (1/1 checks passed).

Choose the account you would like to use to perform operations for
this configuration:
 [1] XXXX@gmail.com
 [2] XXXX@gmail.com
 [3] Log in with a new account
Please enter your numeric choice:  1

You are logged in as: [komedapeople@gmail.com].

Pick cloud project to use:
 [1] XXXXXXX
 [2] gke-django-tutorial
 [3] Create a new project
Please enter numeric choice or text value (must exactly match list
item):  2

Your current project has been set to: [gke-django-tutorial].

Not setting default zone/region (this feature makes it easier to use
[gcloud compute] by setting an appropriate default value for the
--zone and --region flag).
See https://cloud.google.com/compute/docs/gcloud-compute section on how to set
default compute region and zone manually. If you would like [gcloud init] to be
able to do this for you the next time you run it, make sure the
Compute Engine API is enabled for your project on the
https://console.developers.google.com/apis page.

Your Google Cloud SDK is configured and ready to use!

* Commands that require authentication will use komedapeople@gmail.com by default
* Commands will reference project `gke-django-tutorial` by default
Run `gcloud help config` to learn how to change individual settings

This gcloud configuration is called [gke-django-tutorial]. You can create additional configurations if you work with multiple accounts and/or projects.
Run `gcloud topic configurations` to learn more.

Some things to try next:

* Run `gcloud --help` to see the Cloud Platform services you can interact with. And run `gcloud help COMMAND` to get help on any gcloud command.
* Run `gcloud topic --help` to learn about advanced features of the SDK like arg files and output formatting


Updates are available for some Cloud SDK components.  To install them,
please run:
  $ gcloud components update



To take a quick anonymous survey, run:
  $ gcloud survey

```

### å¿…è¦ãªAPIã‚’æœ‰åŠ¹ã«ã™ã‚‹

Datastore, Pub/Sub, Cloud Storage JSON, Cloud Logging, and Google+APIs ã‚’æœ‰åŠ¹ã«ã—ã¾ã™ã€‚

### CloudSQLã®æº–å‚™

#### Cloud SQL Adminã‚’æœ‰åŠ¹ã«ã™ã‚‹

```sh
$\gke-django-tutorial\gcloud services enable sqladmin
Operation "operations/acf.652ef02f-5bbe-433c-94e5-1b11fcc0def9" finished successfully.
```

#### CloudSQL proxy

Cloud SQL Proxyã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦`cloud_sql_proxy.exe`ã«åå‰ã‚’å¤‰æ›´ã—ã¾ã™ã€‚
å‚è€ƒ: https://cloud.google.com/python/django/kubernetes-engine#installingthecloudsqlproxy

#### ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ä½œæˆ

CloudSQLã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚

```sh
ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ³ã‚¸ãƒ³ã®é¸æŠ: PostgreSQL
ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ID: websql
ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: gke_django_tutorial
ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³:
    ãƒªãƒ¼ã‚¸ãƒ§ãƒ³: asia-northeast1
    ã‚¾ãƒ¼ãƒ³: asia-notrheast1-a
ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³: PostgreSQL 11
```

#### ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®åˆæœŸåŒ–

å…ˆã»ã©ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸ`cloud_sql_proxy.exe`ã‚’ä½¿ã£ã¦CloudSQLã«æ¥ç¶šã™ã‚‹ãŸã‚ã®`connectionName`ã‚’ç¢ºèªã—ã¾ã™ã€‚

```sh
# connecsionNameã®ç¢ºèª
$\gke-django-tutorial\gcoud sql instances describe websql
connectionName: gke-django-tutorial:asia-northeast1:websql

# ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®æ¥ç¶š
$\gke-django-tutorial\gcoud_sql_proxy.exe -instances="gke-django-tutorial:asia-northeast1:websql"=tcp:5432
2020/04/28 17:49:51 Listening on 127.0.0.1:5432 for gke-django-tutorial:asia-northeast1:websql
2020/04/28 17:49:51 Ready for new connections
```

ã“ã®ã‚³ãƒãƒ³ãƒ‰ã«ã‚ˆã£ã¦localç’°å¢ƒã‹ã‚‰CloudSQLã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«æ¥ç¶šã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚

#### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ä½œæˆ

ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½œæˆã—ã¾ã—ã‚‡ã†ã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ä¸Šã®`websql`ã‚’é¸æŠã—ã¦`ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹`ã‹ã‚‰`ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½œæˆ`ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```sh
ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å: web-db
```

#### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä½œæˆ

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ã¦ãŠãã¾ã™ã€‚
```sh
ãƒ¦ãƒ¼ã‚¶ãƒ¼å: master
ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: websql-pass
```

#### CloudSQLã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ä½œæˆ

CloudSQlã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ã¦ã€jsonå½¢å¼ã®ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚­ãƒ¼ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ã‚‡ã†ã€‚

```sh
ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå: gke-django-tutorial-service-account
ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆID: gke-django-tutorial-service@gke-django-tutorial.iam.gservice
æ¨©é™: Cloud SQL ç®¡ç†è€…
â‡’ã‚­ãƒ¼ã®ä½œæˆã§jsonå½¢å¼ã‚’é¸æŠ
```

ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚­ãƒ¼ã¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç›´ä¸‹ã«`secrets`ã¨ã„ã†ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã¦è¨­ç½®ã—ã¾ã—ãŸã€‚

```sh
$\gke-django-tutorial\mkdir secrets
```

#### ç’°å¢ƒå¤‰æ•°ã®è¨­å®š

Localã®Djangoã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’CloudSQLã«è¨­å®šã—ã¦èµ·å‹•ã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚
`DATABASE_USER`ã¨`DATABASE_PASSWORD`ã‚’ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦åˆ©ç”¨ã™ã‚‹ãŸã‚ã€`.env`ãƒ•ã‚¡ã‚¤ãƒ«ã«è¿½åŠ ã—ã¾ã™ã€‚

```sh
SECRET_KEY='nz8t((i_mali=%0+z_g+uc**9dgky8)74slvs&6h$=9b^8t7$@'
DEBUG=False
DATABASE_USER=master
DATABASE_PASSWORD=websql-pass
```

#### Pythonãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®è¿½åŠ 

Djangoã‹ã‚‰Postgresã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ãƒ‡ãƒ—ãƒ­ã‚¤ã«å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’è¿½åŠ ã—ã¦ãŠãã¾ã™ã€‚

```sh
# ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
(venv)$\gke-django-tutorial\backend\python -m pip install wheel gunicorn psycopg2-binary

# requirements.txtã®æ›´æ–°
(venv)$\gke-django-tutorial\backend\python -m pip freeze > requirements.txt
```

#### backend/config/settings.py

Djangoã®DATABASEè¨­å®šã‚’db.sqlite3ã‹ã‚‰CloudSQLã«å¤‰æ›´ã—ã¾ã™ã€‚
`.env`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›´æ¥å‚ç…§ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€`python-dotenv`ã‚’ä½¿ã£ã¦èª­ã¿è¾¼ã¿ã¾ã™ã€‚

```python
# backend/config/setting.sy

import os
from dotenv import load_dotenv  # è¿½åŠ 

# Build paths inside the project like this: os.path.join(BASE_DIR, ...)
BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
PROJECT_DIR = os.path.basename(BASE_DIR)

load_dotenv(os.path.join(BASE_DIR, '.env'))  # è¿½åŠ 

# Quick-start development settings - unsuitable for production
# See https://docs.djangoproject.com/en/3.0/howto/deployment/checklist/

# SECURITY WARNING: keep the secret key used in production secret!
SECRET_KEY = os.environ.get('SECRET_KEY')  # å¤‰æ›´

# SECURITY WARNING: don't run with debug turned on in production!
DEBUG = os.environ.get('DEBUG')  # å¤‰æ›´

DATABASES = {
    'default': {
        # If you are using Cloud SQL for MySQL rather than PostgreSQL, set
        # 'ENGINE': 'django.db.backends.mysql' instead of the following.
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': 'web-db',
        'USER': os.getenv('DATABASE_USER'),
        'PASSWORD': os.getenv('DATABASE_PASSWORD'),
        'HOST': '127.0.0.1',
        'PORT': '5432',
    }
}
```

#### ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒCloudSQLã«å¤‰æ›´ã—ãŸã®ã§ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã—ç›´ã™å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```sh
(venv)$\gke-django-tutorial\backend\python manage.py migrate
Operations to perform:
  Apply all migrations: admin, auth, contenttypes, sessions, todo
Running migrations:
  Applying contenttypes.0001_initial... OK
  Applying auth.0001_initial... OK
  Applying admin.0001_initial... OK
  Applying admin.0002_logentry_remove_auto_add... OK
  Applying admin.0003_logentry_add_action_flag_choices... OK
  Applying contenttypes.0002_remove_content_type_name... OK
  Applying auth.0002_alter_permission_name_max_length... OK
  Applying auth.0003_alter_user_email_max_length... OK
  Applying auth.0004_alter_user_username_opts... OK
  Applying auth.0005_alter_user_last_login_null... OK
  Applying auth.0006_require_contenttypes_0002... OK
  Applying auth.0007_alter_validators_add_error_messages... OK
  Applying auth.0008_alter_user_username_max_length... OK
  Applying auth.0009_alter_user_last_name_max_length... OK
  Applying auth.0010_alter_group_name_max_length... OK
  Applying auth.0011_update_proxy_permissions... OK
  Applying sessions.0001_initial... OK
  Applying todo.0001_initial... OK
```

å•é¡ŒãªãCloudSQLã«ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚

#### ç®¡ç†ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¿½åŠ 

åŒæ§˜ã«ç®¡ç†ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã—ã¾ã™ã€‚

```sh
(venv)$\gke-django-tutorial\backend\python manage.py createsuperuser
ãƒ¦ãƒ¼ã‚¶ãƒ¼å (leave blank to use 'masayoshi'): masayoshi
ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹: komedapeople@gmail.com
Password:
Password (again):
Superuser created successfully.
```

é–‹ç™ºç”¨ã‚µãƒ¼ãƒãƒ¼ã‚’ç«‹ã¡ä¸Šã’ã¦adminãƒšãƒ¼ã‚¸ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’3ã¤ã»ã©è¿½åŠ ã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚

```sh
(venv)$\gke-django-tutorial\backend\python manage.py runserver
```

### Cloud Storageã®æº–å‚™

é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’Google Clodu Storageã«æ ¼ç´ã™ã‚‹ãŸã‚ã®è¨­å®šã‚’è¡Œã„ã¾ã™ã€‚
ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ä½œæˆã—ã¦é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚ã“ã‚Œã‚’ã—ãªã„ã¨adminç”»é¢ãªã©ã®cssãŒåæ˜ ã•ã‚Œã¾ã›ã‚“ã€‚

```sh
# ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®ä½œæˆ
(venv)$\gke-django-tutorial\backend\gsutil mb gs://gke-django-storage
Creating gs://gke-django-storage/...

# å…¬é–‹è¨­å®š
(venv)$\gke-django-tutorial\backend\gsutil defacl set public-read gs://gke-django-storage
Setting default object ACL on gs://gke-django-storage/...
/ [1 objects]

# é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é›†ã‚ã‚‹
(venv)$\gke-django-tutorial\backend\python manage.py collectstatic

# Cloud Storageã«é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
(venv)$\gke-django-tutorial\backend\gsutil rsync -R staticfiles/ gs://gke-django-storage/static

```

`backend/config/settings.py`ã®`STATIC_URL`ã‚’GCSã‚’å‚ç…§ã™ã‚‹ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚

```python
# backend/config/settings.py
STATIC_URL = 'https://storage.googleapis.com/gke-django-storage/static/'
```

### GKEã¸ãƒ‡ãƒ—ãƒ­ã‚¤

ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚’ä½œæˆã—ã¦ã‚³ãƒ³ãƒ†ãƒŠã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚Serviceã¨Ingressã‚’è¨­å®šã™ã‚‹ã“ã¨ã§å¤–éƒ¨ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

#### ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ä½œæˆ

ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ã‚¯ãƒ©ã‚¹ã‚¿ã‚’ä½œæˆã—ã¾ã™ã€‚

```sh
ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å: gke-django-tutorial
ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ—:ã‚¾ãƒ¼ãƒ³:asia-notrheast1-a
ãƒã‚¹ã‚¿ãƒ¼ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³: 1.14.10-gke.27(ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)
```

#### contextsã®å…¥æ‰‹

ä½œæˆã—ãŸã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã®kubectlã‹ã‚‰åˆ©ç”¨ã™ã‚‹ãŸã‚ã«contextsã‚’å…¥æ‰‹ã™ã‚‹ã€‚

```sh
$\gke-django-tutorial\gcloud container clusters get-credentials gke-django-tutorial --zone="asia-northeast1-a"
Fetching cluster endpoint and auth data.
kubeconfig entry generated for gke-django-tutorial.

# ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãŒé©ç”¨ã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã™ã‚‹ã€‚
$\gke-django-tutorial\kubectl config current-context
gke_gke-django-tutorial_asia-northeast1-a_gke-django-tutorial
```

#### CloudSQLã®è¨­å®š

Secretsã‚’ä½œæˆã—ã¦CloudSQLã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦å®‰å…¨ã«ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
GKE ã‹ã‚‰ Cloud SQL ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½¿ç”¨ã™ã‚‹ã«ã‚ãŸã£ã¦ã€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ¬ãƒ™ãƒ«ã‚¢ã‚¯ã‚»ã‚¹ã¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹ã«é–¢ã™ã‚‹secrets ã‚’ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

å‚è€ƒ: [ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡]:(https://cloud.google.com/sql/docs/mysql/instance-access-control)

ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ¬ãƒ™ãƒ«ã®ã‚¢ã‚¯ã‚»ã‚¹ã«ã¤ã„ã¦ secret ã‚’ä½œæˆã™ã‚‹ã€‚

```sh
$\gke-django-tutorial\kubectl create secret generic cloudsql-oauth-credentials --from-file=credentials.json=".\secrets\cloudsql\gke-django-tutorial-c9c425adccbd.json"

secret/cloudsql-oauth-credentials created
```

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã‚¢ã‚¯ã‚»ã‚¹ã«é–¢ã™ã‚‹ secret ã‚’ä½œæˆã™ã‚‹ã€‚

```sh
$\gke-django-tutorial\kubectl create secret generic cloudsql --from-literal=username="master" --from-literal=password="master-pass"
```

#### ç’°å¢ƒå¤‰æ•°ã®è¨­å®š

.envãƒ•ã‚¡ã‚¤ãƒ«ã«è¨˜è¿°ã•ã‚Œã¦ã„ã‚‹æ®‹ã‚Šã®`SECRET_KEY`ã‚’secretã«è¿½åŠ ã—ã¾ã—ã‚‡ã†ã€‚
`DEBUG`ã¯Falseã¨ã—ã¦ãŠãã¾ã™ã€‚

```sh
$\gke-django-tutorial\kubectl create secret generic secret-key --from-literal=SECRET_KEY="nz8t((i_mali=%0+z_g+uc**9dgky8)74slvs&6h$=9b^8t7$@"
```

`backend/config/settings.py`ã§é–¢ä¿‚ã®ã‚ã‚‹å€‹æ‰€ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªçŠ¶æ…‹ã«ãªã‚Šã¾ã™ã€‚

```python
# backend/config/settings.py

import os

# Build paths inside the project like this: os.path.join(BASE_DIR, ...)
BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
PROJECT_DIR = os.path.basename(BASE_DIR)

# Quick-start development settings - unsuitable for production
# See https://docs.djangoproject.com/en/3.0/howto/deployment/checklist/

# SECURITY WARNING: keep the secret key used in production secret!
SECRET_KEY = os.environ.get('SECRET_KEY')  # å¤‰æ›´

# SECURITY WARNING: don't run with debug turned on in production!
DEBUG = False

DATABASES = {
    'default': {
        # If you are using Cloud SQL for MySQL rather than PostgreSQL, set
        # 'ENGINE': 'django.db.backends.mysql' instead of the following.
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': 'web-db',
        'USER': os.environ.get('DATABASE_USER'),
        'PASSWORD': os.environ.get('DATABASE_PASSWORD'),
        'HOST': '127.0.0.1',
        'PORT': '5432',
    }
}

```

#### ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã®ç”¨æ„

ãƒ­ãƒ¼ã‚«ãƒ«ã§ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦Google Cloud Registryã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚
ã‚¤ãƒ¡ãƒ¼ã‚¸åã¯`gcr.io/${PROJECT}/${IMAGENAME}:${TAGNAME}`å½¢å¼ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```sh
# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã®ç¢ºèª
$\gke-django-tutorial\gcloud config get-value project
Your active configuration is: [gke-django-tutorial]
gke-django-tutorial

# ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰
# backend
$\gke-django-tutorial\docker image build --no-cache -t gcr.io/gke-django-tutorial/backend:latest ./backend

# frontend
$\gke-django-tutorial\docker image build --no-cache -t gcr.io/gke-django-tutorial/frontend:latest ./frontend

# ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’GCRã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
# backend
$\gke-django-tutorial\gcloud docker -- push gcr.io/gke-django-tutorial/backend:latest
WARNING: `gcloud docker` will not be supported for Docker client versions above 18.03.

As an alternative, use `gcloud auth configure-docker` to configure `docker` to
use `gcloud` as a credential helper, then use `docker` as you would for non-GCR
registries, e.g. `docker pull gcr.io/project-id/my-image`. Add
`--verbosity=error` to silence this warning: `gcloud docker
--verbosity=error -- pull gcr.io/project-id/my-image`.

See: https://cloud.google.com/container-registry/docs/support/deprecation-notices#gcloud-docker

The push refers to repository [gcr.io/gke-django-tutorial/backend]
12ed78fdfd14: Pushed
485427ae6881: Pushed
bb530f6bab17: Pushed
4eae8da6dc9e: Pushed
a91544cdf6ea: Pushed
956d28316107: Layer already exists
86120ec29f78: Layer already exists
5d34cecc2826: Layer already exists
baf481fca4b7: Layer already exists
3d3e92e98337: Layer already exists
8967306e673e: Layer already exists
9794a3b3ed45: Layer already exists
5f77a51ade6a: Layer already exists
e40d297cf5f8: Layer already exists
latest: digest: sha256:3905957cfddea8454288b460adf8b134d0de1bc0791dbc8cf3fe7b9e6012512f size: 3267

# frontend
$\gke-django-tutorial\gcloud docker -- push gcr.io/gke-django-tutorial/frontend:latest
WARNING: `gcloud docker` will not be supported for Docker client versions above 18.03.

As an alternative, use `gcloud auth configure-docker` to configure `docker` to
use `gcloud` as a credential helper, then use `docker` as you would for non-GCR
registries, e.g. `docker pull gcr.io/project-id/my-image`. Add
`--verbosity=error` to silence this warning: `gcloud docker
--verbosity=error -- pull gcr.io/project-id/my-image`.

See: https://cloud.google.com/container-registry/docs/support/deprecation-notices#gcloud-docker

The push refers to repository [gcr.io/gke-django-tutorial/frontend]
c6c151685fbb: Pushed
ef3845fc4e9d: Pushed
069d14dab7a7: Pushed
a3a63dfb31f4: Pushed
2fcc481d7fdd: Pushed
203542cdccd7: Pushed
37d4010f40f0: Pushed
f895d244bc8e: Pushed
03dc1830d2d5: Pushed
1d7382716a27: Pushed
01727b1a72df: Layer already exists
69dfa7bd7a92: Layer already exists
4d1ab3827f6b: Layer already exists
7948c3e5790c: Layer already exists
latest: digest: sha256:26d0836290483f2f58141db9bd18a66a5c5b99a3ce9da3643679592d0d8bb5ec size: 3261

```

#### Frontendã®ãƒ‡ãƒ—ãƒ­ã‚¤

Frontendã®Deploymentã‚’ä½œæˆã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚deploymentã¨ã—ã¦`frontend-react.yml`ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

```sh
$\gke-django-tutorial\type nul > frontend-deployment.yml
```

```yml
# frontend-deployment.yml
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: frontend
  labels:
    app: frontend
spec:
  replicas: 1
  template:
    metadata:
      labels:
        app: frontend
    spec:
      containers:
        - name: frontend
          image: gcr.io/gke-django-tutorial/frontend:latest
          imagePullPolicy: Always
          command: ["npm", "start"]
          ports:
          - containerPort: 3000

```

```sh
$\gke-django-tutorial\kubectl create -f frontend-deployment.yml
deployment.extensions/frontend created

# ç¢ºèª
$\gke-django-tutorial\kubectl get pods
NAME                        READY   STATUS              RESTARTS   AGE
frontend-77f75d4c47-45j4q   0/1     ContainerCreating   0          27s
```

```sh
$ kubectl logs ~~

> frontend@0.1.0 start /code
> react-scripts start

[34mâ„¹[39m [90mï½¢wdsï½£[39m: Project is running at http://10.24.0.8/
[34mâ„¹[39m [90mï½¢wdsï½£[39m: webpack output is served from
[34mâ„¹[39m [90mï½¢wdsï½£[39m: Content not from webpack is served from /code/public
[34mâ„¹[39m [90mï½¢wdsï½£[39m: 404s will fallback to /
Starting the development server...
```

#### Backendã®ãƒ‡ãƒ—ãƒ­ã‚¤

frontendã¨åŒã˜ã‚ˆã†ã«backendã®Deploymentã‚’ä½œæˆã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚
`backend-deployment.yml`ã‚’ä½œæˆã—ã¾ã™ã€‚

```sh
$\gke-django-tutorial\type nul > backend-deployment.yml
```



#### 
